name: CI

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  # NOTE: Playwright Electron E2E is intentionally not part of this workflow.
  # It is run as post-merge validation in .github/workflows/e2e.yml so flaky
  # Electron runners do not block PR merges.

  quality:
    name: quality (lint, typecheck, unit tests)
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Initialize environment
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install node modules
        run: npm ci --no-audit --no-fund --progress=false
        env:
          # Required for @vscode/ripgrep to download binaries without hitting GitHub API rate limits
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Verify branding (fast guardrail)
        run: node scripts/verify-branding.mjs
      - name: Verify no Dyad branding (fast guardrail)
        run: node scripts/verify-no-dyad-branding.mjs
      - name: Verify brand IDs consistency (fast guardrail)
        run: node scripts/verify-brand-ids.mjs
      - name: Verify Windows AUMID (fast guardrail)
        run: node scripts/verify-windows-aumid.mjs
      - name: Verify tray icon configuration (fast guardrail)
        run: node scripts/verify-tray-icon-config.mjs
      - name: Verify icon hashes (ABBA artwork guardrail)
        run: node scripts/verify-icon-hashes.mjs
      - name: Verify Vault configuration (fast guardrail)
        run: node scripts/verify-vault-config.mjs
      - name: Verify CSP connect-src (fast guardrail)
        run: node scripts/verify-csp-connect-src.mjs
      - name: Verify backup entrypoints (fast guardrail)
        run: node scripts/verify-backup-entrypoints.mjs
      - name: Verify GitHub OAuth config (fast guardrail)
        run: node scripts/verify-github-oauth-config.mjs
      - name: Presubmit (prettier:check + lint)
        run: npm run presubmit
      - name: Type-checking
        run: npm run ts
      - name: Unit tests
        run: npm run test

  build:
    name: build (${{ matrix.os.name }})
    strategy:
      fail-fast: false
      matrix:
        os:
          - { name: "windows", image: "windows-latest" }
          - { name: "macos", image: "macos-latest" }
    runs-on: ${{ matrix.os.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Initialize environment
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: npm
          cache-dependency-path: package-lock.json
      - name: Install node modules
        run: npm ci --no-audit --no-fund --progress=false
        env:
          # Required for @vscode/ripgrep to download binaries without hitting GitHub API rate limits
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build (Electron package)
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
        run: npm run pre:e2e
      - name: Verify Windows EXE icon (Windows only)
        if: matrix.os.name == 'windows'
        run: node scripts/verify-windows-exe-icon.mjs
