#!/usr/bin/env node
/**
 * CI Guardrail: Verify icon files contain correct ABBA artwork
 *
 * This script verifies icon files by SHA256 hash, NOT just by existence.
 * This prevents shipping incorrect artwork (e.g., Dyad "D" instead of ABBA "A").
 *
 * Run: node scripts/verify-icon-hashes.mjs
 */

import fs from "fs";
import path from "path";
import crypto from "crypto";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const ROOT = path.resolve(__dirname, "..");

// Expected SHA256 hashes for ABBA AI icon files
// These hashes are generated by scripts/regenerate-icons.mjs
// If you need to update icons, regenerate them from assets/logo.svg
const EXPECTED_HASHES = {
  // Windows app icon (Setup.exe, app.exe, shortcuts)
  "assets/icon/logo.ico":
    "C42987EE0A48C95765C56CC111A482960E526F355CA102812EEB63619B8DB1EF",
  // macOS app icon
  "assets/icon/logo.icns":
    "AB88D8774A8B386270DB2E30590E8924C22BAC3BB78CBA6907BC8243E2C919C2",
  // Linux / general PNG
  "assets/icon/logo.png":
    "46FBED1650AA725B31018BBFC45B33BD81013F4F55A9727739FF6F5763496A5C",
  // Windows tray/taskbar icon
  "assets/icon/tray.ico":
    "625C1FF0312F8A9EFAB3F7EB1918A1A7FDCF2715BF7DF2EDE3630020A34C1CD7",
};

// Known Dyad icon hash - if we see this, definitely fail
const DYAD_ICON_HASH =
  "848148CB8B22F5B3D5AD703BB58CDE01C80D8FFE3E6307A2FBB4E142281F669E";

function computeHash(filePath) {
  const fileBuffer = fs.readFileSync(filePath);
  return crypto
    .createHash("sha256")
    .update(fileBuffer)
    .digest("hex")
    .toUpperCase();
}

function main() {
  console.log("ðŸ” Verifying ABBA AI icon artwork by SHA256 hash...\n");

  const errors = [];
  const warnings = [];

  for (const [relativePath, expectedHash] of Object.entries(EXPECTED_HASHES)) {
    const fullPath = path.join(ROOT, relativePath);
    const fileName = path.basename(relativePath);

    if (!fs.existsSync(fullPath)) {
      errors.push(`âŒ Missing icon file: ${relativePath}`);
      continue;
    }

    const actualHash = computeHash(fullPath);

    if (actualHash === DYAD_ICON_HASH) {
      errors.push(
        `âŒ ${fileName}: Contains DYAD artwork (not ABBA)!\n` +
          `   Hash: ${actualHash}\n` +
          `   This is the original Dyad icon - regenerate icons with: npm run regenerate-icons`,
      );
    } else if (actualHash !== expectedHash) {
      errors.push(
        `âŒ ${fileName}: Hash mismatch\n` +
          `   Expected: ${expectedHash}\n` +
          `   Actual:   ${actualHash}\n` +
          `   Icon may have been modified or corrupted. Regenerate with: npm run regenerate-icons`,
      );
    } else {
      console.log(`âœ… ${fileName}: ABBA artwork verified`);
      console.log(`   Hash: ${actualHash.substring(0, 16)}...`);
    }
  }

  // Also verify the canonical brand source exists
  const brandSource = path.join(ROOT, "assets/brand/abba-logo-1024.png");
  if (fs.existsSync(brandSource)) {
    const hash = computeHash(brandSource);
    console.log(`âœ… Brand source (1024px PNG) exists`);
    console.log(`   Hash: ${hash.substring(0, 16)}...`);
  } else {
    warnings.push(
      `âš ï¸  Missing canonical brand source: assets/brand/abba-logo-1024.png\n` +
        `   Run: npm run regenerate-icons`,
    );
  }

  // Check SVG source exists
  const svgSource = path.join(ROOT, "assets/logo.svg");
  if (!fs.existsSync(svgSource)) {
    errors.push(`âŒ Missing SVG source: assets/logo.svg`);
  } else {
    console.log(`âœ… SVG source exists: assets/logo.svg`);
  }

  // Summary
  console.log("\n" + "=".repeat(60) + "\n");

  if (warnings.length > 0) {
    console.log("âš ï¸  Warnings:\n");
    warnings.forEach((w) => console.log(`  ${w}`));
    console.log("");
  }

  if (errors.length > 0) {
    console.log("âŒ Icon verification FAILED:\n");
    errors.forEach((e) => console.log(`  ${e}\n`));
    console.log(
      "ðŸ’¡ To fix: Run `npm run regenerate-icons` to regenerate all icons from the canonical SVG source.",
    );
    process.exit(1);
  }

  console.log("âœ… All icon hashes verified - ABBA artwork confirmed!");
  process.exit(0);
}

main();
